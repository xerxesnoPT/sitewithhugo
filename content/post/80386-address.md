---
title: "80386寻址方式"
date: 2019-02-02T13:06:01+08:00
draft: false
categories: ['二进制']
tags: ['asm']
---

## 实模式

CPU为了兼容，保留了实模式,现代操作系统在刚加电时首先运行在实模式下，然后再切换到保护模式下运行。

- 逻辑地址：即逻辑上的地址，实模式下由“段基地址+段内偏移”组成；保护模式下由“段选择符+段内偏移”组成。
- 线性地址：逻辑地址经分段机制后就成线性地址，它是平坦的；如果不启用分页，那么此线性地址即物理地址。
- 物理地址：线性地址经分页转换后就成了物理地址。

8086 只有16位，地址总线20位。要寻找2的20次方 即1mb地址。16位 2的16次方 64kb远远不够。就使用段寄存器
16位x 10h(16)+16位 = 2的16次方乘以 2的4次方 = 2的20次方 进行寻址。 每个段最大也就64kb.

## 保护模式

- 段寄存器其实保存的是段选择符，而不是段基地址。要通过段选择符来找到实际的段基地址。
- 段选择符16位，0-1位RPL,请求特权级。2位TI TI位0 使用GDT , TI=1 ,LDT. 3-15位表示索引,共13位，索引保护模式下最多可以表示2^13=8192个,再加上2位TI 一共可以有 2x8192=16384个段描述符。由于ebx等都是32位的，所以段内偏移地址最大可达4gb。这样16384x4gb=64tb。最大的逻辑/虚拟地址。
- 段描述符8字节，64位。

- 段选择子结构，16位数字

```bash
|   1   |     0    |  字节
|7654321076543 2 10|  比特
|-------------|-|--|  占位
|    INDEX    |T|R |  含义
|             |I|P |
|             | |L |
---------------------
```
- INDEX: GDT或者LDT的索引号
- TI:
- RPL: 请求特权级。以什么样的权限去访问段。

- 段描述符结构。 8字节64位
```bash
|   7    |     6       |     5     |   4    |   3    |   2    |   1    |   0    |  字节
|76543210|7 6 5 4 3210 |7 65 4 3210|76543210|76543210|76543210|76543210|76543210|  比特
|--------|-|-|-|-|---- |-|--|-|----|--------|--------|--------|--------|--------|  占位
|  BASE  |G|D|0|A|LIMIT|P|D |S|TYPE|<------- BASE 23-0 ------>|<-- LIMIT 15-0 ->|  含义
|  31-24 | |/| |V|19-16| |P |
           |B| |L|     | |L |
---------------------
```

- BASE: 段基址，由上图中的两部分(BASE 31-24 和 BSE23-0)组成,一共32位
- G：LIMIT的单位，该位 0 表示单位是字节，1表示单位是 4KB
- D/B: 该位为 0 表示这是一个 16 位的段，1 表示这是一个 32 位段
- AVL: 该位是用户位，可以被用户自由使用
- LIMIT: 段的界限，单位由 G 位决定。数值上（经过单位换算后的值）等于段的长度（字节）- 1。
- P: 段存在位，该位为 0 表示该段不存在，为 1 表示存在。
- DPL：段权限
- S: 该位为 1 表示这是一个数据段或者代码段。为 0 表示这是一个系统段（比如调用门，中断门等）
- TYPE: 根据 S 位的结果，再次对段类型进行细分。
